<!-- Student Survey Tab Content -->
<div id="studentreg-survey" class="tab-content">
  <section id="studentreg-survey" class="bg-gradient-to-b from-gray-50 to-white py-16 md:py-24">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl">
      <div class="text-center mb-12">
        <span class="inline-block px-4 py-2 bg-msu-main-color/10 text-msu-main-color text-sm font-semibold rounded-full mb-4">
          Student Feedback Survey
        </span>
        <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
          Student Satisfaction Survey <span class="text-msu-main-color">For Regular </span>
        </h2>
        <div class="w-24 h-1.5 bg-gradient-to-r from-msu-gold to-msu-maroon mx-auto rounded-full"></div>
        <p class="text-lg text-gray-600 mt-6 max-w-2xl mx-auto">
          Your feedback helps us improve campus services and facilities
        </p>
      </div>

      <!-- Progress Legend -->
      <div class="verification-legend">
        <div class="verification-legend-item">
          <div class="verification-legend-badge verified">✓</div>
          <span>Verified & Submitted</span>
        </div>
        <div class="verification-legend-item">
          <div class="verification-legend-badge completed">✓</div>
          <span>Completed (Not Submitted)</span>
        </div>
        <div class="verification-legend-item">
          <div class="verification-legend-badge not-completed">✕</div>
          <span>Not Completed</span>
        </div>
      </div>

      <!-- Survey Card -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-msu-main-color to-msu-maroon px-8 py-6">
          <div class="flex items-center">
            <div class="bg-white/20 p-2 rounded-lg mr-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white">Academic Year 2023-2024</h3>
              <p class="text-white/90">Please provide honest feedback about our services</p>
            </div>
          </div>
        </div>

        <div class="p-6 sm:p-8">
          <form id="studentSurveyForm" class="space-y-8">
            <!-- Student Information -->
            <div class="grid md:grid-cols-2 gap-6">
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Year Level <span class="text-msu-maroon">*</span>
                </label>
                <div class="grid grid-cols-4 gap-2">
                  <label class="flex items-center">
                    <input type="radio" name="regyearlevels" value="1st" class="h-4 w-4 text-msu-main-color focus:ring-msu-main-color">
                    <span class="ml-2 text-sm text-gray-700">1st</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="regyearlevels" value="2nd" class="h-4 w-4 text-msu-main-color focus:ring-msu-main-color">
                    <span class="ml-2 text-sm text-gray-700">2nd</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="regyearlevels" value="3rd" class="h-4 w-4 text-msu-main-color focus:ring-msu-main-color">
                    <span class="ml-2 text-sm text-gray-700">3rd</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="regyearlevels" value="4th" class="h-4 w-4 text-msu-main-color focus:ring-msu-main-color">
                    <span class="ml-2 text-sm text-gray-700">4th</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Course <span class="text-msu-maroon">*</span>
                </label>
                <input type="text" name="regcourses" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-msu-main-color focus:border-msu-main-color" placeholder="Enter your course" required>
              </div>
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Student Number <span class="text-msu-maroon">*</span>
              </label>
              <input type="text" name="regstudids" class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-msu-main-color focus:border-msu-main-color" placeholder="e.g. 2023-12345" required>
            </div>

            <!-- Reference Code Field -->
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Reference Code <span class="text-msu-maroon">*</span>
              </label>
              <div class="flex items-center">
                <input 
                  type="text" 
                  name="references" 
                  id="regreferenceCodeInputs"
                  class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-msu-main-color focus:border-msu-main-color bg-gray-100 font-mono" 
                  placeholder="Will be generated automatically" 
                  readonly
                  required
                />
                <button 
                  type="button" 
                  id="regcopyReferenceCodeBtns"
                  class="ml-2 p-2 text-gray-500 hover:text-msu-main-color focus:outline-none"
                  title="Copy to clipboard"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                  </svg>
                </button>
              </div>
              <p class="mt-1 text-xs text-gray-500">This unique code identifies your submission</p>
            </div>

            <!-- Introductory Message -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">
                Dear Student,<br><br>
                As a valuable member of the university, we would like to ask your opinion about the 
                frontline services you have received and experienced here on campus during the School Year 
                2023-2024.<br><br>
                Your answer will provide us valuable inputs to serve you better and to make sure we meet 
                your expectations. Please check the number that corresponds to your level of assessment.
              </p>
            </div>

            <!-- Service Sections -->
            {[
              {
                title: "Library Services",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h8m-8 4h5M17 14a2 2 0 100-4 2 2 0 000 4z" />
                        <circle cx="17" cy="17" r="2" stroke="currentColor" stroke-width="2" fill="none"/>
                      </svg>`,
                questions: [
                  { 
                    text: "1. The admission staff responds to questions and concerns in a timely manner.", 
                    entry: "entry.1132405313"
                  },
                  { 
                    text: "2. The admissions policies and procedures are posted in a clear and systematic manner in bulletin boards.", 
                    entry: "entry.470748009"
                  },
                  // Add more questions as needed
                ],
                commentsEntry: "entry.1263059269",
                suggestionsEntry: "entry.415098962"
              },
              {
                title: "Guidance Services",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                      </svg>`,
                questions: [
                  { 
                    text: "1. The guidance staff are approachable and accommodating.", 
                    entry: "entry.987654321"
                  },
                  // Add more questions as needed
                ],
                commentsEntry: "entry.987654322",
                suggestionsEntry: "entry.987654323"
              }
              // Add more services as needed
            ].map((servicereg, serviceIndex) => (
              <div class="service-section">
                <div class="service-card">
                  <label class="service-card-header">
                    <input type="radio" name="selected-service" class="service-card-checkbox" value={servicereg.title.toLowerCase().replace(' ', '-')}>
                    <div class="service-card-icon" set:html={servicereg.icon}></div>
                    <div class="service-card-title">{servicereg.title}</div>
                  </label>
                  
                  <div class="service-questions">
                    <div class="bg-gray-50 p-3 rounded-lg mb-4">
                      <div class="flex items-center justify-between text-xs font-medium text-gray-500">
                        <span>1 (Poor)</span>
                        <span>2 (Fair)</span>
                        <span>3 (Satisfactory)</span>
                        <span>4 (Very Satisfactory)</span>
                        <span>5 (Excellent)</span>
                      </div>
                    </div>
                    
                    {servicereg.questions.map((question, index) => (
                      <div class="form-group mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          {index + 1}. {question.text}
                        </label>
                        <div class="flex items-center justify-between">
                          {[1, 2, 3, 4, 5].map((rating) => (
                            <label class="flex flex-col items-center">
                              <input 
                                type="radio" 
                                name={question.entry}
                                value={rating}
                                required
                                class="h-5 w-5 text-msu-main-color focus:ring-msu-main-color border-gray-300"
                              >
                              <span class="mt-1 text-xs text-gray-500">
                                {rating === 1 ? 'Poor' : 
                                rating === 2 ? 'Fair' : 
                                rating === 3 ? 'Good' : 
                                rating === 4 ? 'Very Good' : 'Excellent'}
                              </span>
                            </label>
                          ))}
                        </div>
                      </div>
                    ))}
                    
                    <!-- Comments Section -->
                    <div class="pt-6 border-t border-gray-200">
                      <h4 class="text-lg font-semibold text-gray-900 mb-4">Additional Feedback</h4>
                      
                      <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          Comments
                        </label>
                        <textarea 
                          name={servicereg.commentsEntry}
                          rows="3" 
                          class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-msu-main-color focus:border-msu-main-color" 
                          placeholder="Share your experience or suggestions..."
                        ></textarea>
                      </div>

                      <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          Suggestions/Recommendations
                        </label>
                        <textarea 
                          name={servicereg.suggestionsEntry}
                          rows="3" 
                          class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-msu-main-color focus:border-msu-main-color" 
                          placeholder="How can we serve you better?"
                        ></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            ))}

            <!-- Form Footer -->
            <div class="pt-6">
              <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                <p class="text-sm text-gray-500">
                  All responses are confidential and will be used for service improvement.
                </p>
                <button
                  type="submit"
                  class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-msu-main-color to-msu-maroon hover:from-msu-main-color-dark hover:to-msu-maroon-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-msu-main-color transition-all"
                >
                  Submit Survey
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon"></div>
      <h3 class="modal-title"></h3>
      <button id="modalCloseButton" class="modal-close">&times;</button>
    </div>
    <div id="modalMessage" class="modal-body"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize services tracking - will be populated from the actual services in the survey
  const services: Record<string, { completed: boolean; verified: boolean }> = {};

  // Tab functionality
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      button.classList.add('active');
      const tabId = button.getAttribute('data-tab');
      const targetTab = document.getElementById(tabId);
      if (targetTab) targetTab.classList.add('active');
      
      sessionStorage.setItem('activeTab', tabId || '');
      
      // Remove progress tracker when switching away from regular student survey
      if (tabId !== 'studentreg-survey') {
        const existingTracker = document.querySelector('.reg-progress-tracker');
        if (existingTracker) existingTracker.remove();
      }
      
      if (tabId === 'studentreg-survey') {
        initializeStudentSurveyreg();
      }
    });
  });
  
  // Set initial active tab
  const storedTab = sessionStorage.getItem('activeTab');
  if (storedTab && document.getElementById(storedTab)) {
    const tabButton = document.querySelector(`.tab-btn[data-tab="${storedTab}"]`) as HTMLElement;
    if (tabButton) tabButton.click();
  } else if (tabButtons.length > 0) {
    (tabButtons[0] as HTMLElement).click();
  }

  // Initialize student survey
  function initializeStudentSurveyreg() {
    // Check internet connectivity
    function checkInternetConnectionreg() {
      return navigator.onLine;
    }

    // Initialize verification status
    function initializeVerificationStatusreg() {
      // Clear existing services
      Object.keys(services).forEach(key => delete services[key]);
      
      // Define the exact services that should be in this survey
      const expectedServices = ['Library Services', 'Guidance Services'];
      
      // Only add services that are in our expected list
      document.querySelectorAll('.service-card').forEach(card => {
        const titleElement = card.querySelector('.service-card-title');
        if (!titleElement) return;
        
        const title = titleElement.textContent?.trim();
        if (!title) return;
        
        // Only add if it's in our expected services list
        if (expectedServices.includes(title)) {
          services[title] = { completed: false, verified: false };
          updateVerificationStatus(card as HTMLElement, services[title]);
        } else {
          console.log('Skipping service not in expected list:', title);
        }
      });
      
      // Debug log to verify services count
      console.log('Services initialized:', Object.keys(services).length, 'services:', Object.keys(services));
      console.log('Expected services:', expectedServices);
      console.log('Services match expected:', Object.keys(services).length === expectedServices.length);
    }

    // Update verification status UI
    function updateVerificationStatus(card: HTMLElement, status: { completed: boolean; verified: boolean }) {
      const existingStatus = card.querySelector('.verification-status');
      if (existingStatus) existingStatus.remove();

      const statusIndicator = document.createElement('div');
      statusIndicator.className = 'verification-status';
      
      if (status.verified) {
        statusIndicator.classList.add('verified');
        statusIndicator.innerHTML = '✓';
        statusIndicator.title = 'Verified and submitted';
      } else if (status.completed) {
        statusIndicator.classList.add('completed');
        statusIndicator.innerHTML = '✓';
        statusIndicator.title = 'Completed (not submitted)';
      } else {
        statusIndicator.classList.add('not-completed');
        statusIndicator.innerHTML = '✕';
        statusIndicator.title = 'Not completed';
      }

      const header = card.querySelector('.service-card-header');
      if (header) header.prepend(statusIndicator);
    }

    // Validate all questions in a service card
    function validateServiceQuestions(serviceCard: HTMLElement) {
      const radioGroups = new Set<string>();
      const answeredGroups = new Set<string>();
      
      serviceCard.querySelectorAll('input[type="radio"]').forEach(radio => {
        const radioElement = radio as HTMLInputElement;
        radioGroups.add(radioElement.name);
        if (radioElement.checked) answeredGroups.add(radioElement.name);
      });
      
      return radioGroups.size === answeredGroups.size;
    }

    // Service card selection and validation
    document.querySelectorAll('.service-card').forEach(card => {
      const cardElement = card as HTMLElement;
      const checkbox = card.querySelector('.service-card-checkbox') as HTMLInputElement;
      const titleElement = card.querySelector('.service-card-title');
      if (!titleElement) return;
      
      const title = titleElement.textContent?.trim();
      if (!title) return;
      
      // Only work with services that are in our expected list
      const expectedServices = ['Library Services', 'Guidance Services'];
      if (!expectedServices.includes(title)) {
        console.log('Skipping service not in expected list:', title);
        return; // Skip this card if not in our expected services list
      }
      
      cardElement.addEventListener('click', function(e) {
        const target = e.target as HTMLElement;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.closest('.form-group')) {
          return;
        }
        
        document.querySelectorAll('.service-card').forEach(c => {
          if (c !== card) {
            c.classList.remove('selected');
            const otherCheckbox = c.querySelector('.service-card-checkbox') as HTMLInputElement;
            if (otherCheckbox) otherCheckbox.checked = false;
          }
        });
        
        cardElement.classList.toggle('selected');
        if (checkbox) checkbox.checked = cardElement.classList.contains('selected');
        
        if (cardElement.classList.contains('selected')) {
          cardElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
      
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          cardElement.classList.toggle('selected', this.checked);
        });
      }
    });

    // Track radio button changes
    document.querySelectorAll('.service-questions input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const serviceCard = this.closest('.service-card') as HTMLElement;
        if (!serviceCard) return;
        
        const titleElement = serviceCard.querySelector('.service-card-title');
        if (!titleElement) return;
        
        const title = titleElement.textContent?.trim();
        if (!title) return;
        
        // Only update if this service is in our expected list
        const expectedServices = ['Library Services', 'Guidance Services'];
        if (expectedServices.includes(title) && services[title]) {
          services[title].completed = validateServiceQuestions(serviceCard);
          updateVerificationStatus(serviceCard, services[title]);
          updateRegProgressTracker();
        }
      });
    });

    // Create progress tracker for regular students
    function createRegProgressTracker() {
      // Only create tracker if we're on the regular student survey tab
      const activeTab = sessionStorage.getItem('activeTab');
      if (activeTab !== 'studentreg-survey') {
        return;
      }
      
      // Remove any existing tracker first
      const existingTracker = document.querySelector('.reg-progress-tracker');
      if (existingTracker) existingTracker.remove();
      
      // Wait for layout to be fully loaded
      const waitForLayout = () => {
        // Check if main content and survey content are loaded
        const mainContent = document.querySelector('main');
        const surveyContent = document.querySelector('#studentreg-survey');
        
        if (!mainContent || !surveyContent) {
          // If not ready, wait a bit more
          setTimeout(waitForLayout, 100);
          return;
        }
        
        // Check if page is fully rendered
        if (document.readyState !== 'complete') {
          setTimeout(waitForLayout, 100);
          return;
        }
        
        // Create tracker after layout is ready
        setTimeout(() => {
          const tracker = document.createElement('div');
          tracker.className = 'reg-progress-tracker';
          tracker.title = 'Survey completion progress';
          tracker.innerHTML = `
            <div class="reg-progress-circle">
              <svg viewBox="0 0 36 36" class="reg-progress-bg">
                <path d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke-dasharray="100, 100"
                />
              </svg>
              <svg viewBox="0 0 36 36" class="reg-progress-fill">
                <path d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke-dasharray="0, 100"
                />
              </svg>
              <div class="reg-progress-text">0%</div>
            </div>
          `;
          
          tracker.addEventListener('click', showRegProgressSummary);
          document.body.appendChild(tracker);
          
          // Add fade-in animation
          tracker.style.opacity = '0';
          tracker.style.transform = 'scale(0.8)';
          tracker.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          
          // Force a reflow and animate in
          setTimeout(() => {
            tracker.style.opacity = '1';
            tracker.style.transform = 'scale(1)';
          }, 50);
        }, 300);
      };
      
      // Start the layout check process
      setTimeout(waitForLayout, 200);
    }

    // Update progress tracker for regular students
    function updateRegProgressTracker() {
      // Only update tracker if we're on the regular student survey tab
      const activeTab = sessionStorage.getItem('activeTab');
      if (activeTab !== 'studentreg-survey') {
        return;
      }
      
      const expectedServices = ['Library Services', 'Guidance Services'];
      const totalServices = expectedServices.length; // Always use expected count
      const completedServices = Object.values(services).filter(s => s.completed || s.verified).length;
      const percentage = Math.round((completedServices / totalServices) * 100);
      
      // Debug logging
      console.log('Reg Progress Tracker Update:');
      console.log('Expected services:', expectedServices);
      console.log('Total services (expected):', totalServices);
      console.log('Completed services:', completedServices);
      console.log('Percentage:', percentage);
      console.log('Services status:', services);
      
      // Verify we have the right services
      const actualServices = Object.keys(services);
      if (actualServices.length !== totalServices) {
        console.warn('Warning: Expected', totalServices, 'services, but found', actualServices.length);
        console.log('Actual services found:', actualServices);
      }
      
      const progressFill = document.querySelector('.reg-progress-fill') as HTMLElement;
      const progressText = document.querySelector('.reg-progress-text') as HTMLElement;
      
      if (progressFill && progressText) {
        progressFill.style.strokeDasharray = `${percentage}, 100`;
        progressText.textContent = `${percentage}%`;
        
        if (percentage === 100) {
          progressFill.style.stroke = '#10B981';
          progressText.style.color = '#10B981';
        } else if (percentage >= 50) {
          progressFill.style.stroke = '#3B82F6';
          progressText.style.color = '#3B82F6';
        } else {
          progressFill.style.stroke = '#1E3A8A';
          progressText.style.color = '#1E3A8A';
        }
      }
    }

    // Show progress summary for regular students
    function showRegProgressSummary() {
      const expectedServices = ['Library Services', 'Guidance Services'];
      const totalServices = expectedServices.length; // Always use expected count
      const completedServices = Object.values(services).filter(s => s.completed && !s.verified).length;
      const verifiedServices = Object.values(services).filter(s => s.verified).length;
      const remainingServices = totalServices - completedServices - verifiedServices;
      
      // Debug logging
      console.log('Reg Progress Summary:');
      console.log('Expected services:', expectedServices);
      console.log('Total services (expected):', totalServices);
      console.log('Completed (not submitted):', completedServices);
      console.log('Verified (submitted):', verifiedServices);
      console.log('Remaining:', remainingServices);
      
      const modal = document.getElementById('feedbackModal') as HTMLElement;
      const modalMessage = document.getElementById('modalMessage') as HTMLElement;
      const modalIcon = modal.querySelector('.modal-icon') as HTMLElement;
      const modalTitle = modal.querySelector('.modal-title') as HTMLElement;
      
      modalTitle.textContent = 'Survey Progress';
      modal.classList.remove('modal-error', 'modal-success');
      
      modalIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      `;
      
      modalMessage.innerHTML = `
        <div class="space-y-3">
          <div class="flex justify-between">
            <span>Total Services:</span>
            <span class="font-medium">${totalServices}</span>
          </div>
          <div class="flex justify-between">
            <span>Completed:</span>
            <span class="font-medium text-green-600">${completedServices}</span>
          </div>
          <div class="flex justify-between">
            <span>Submitted:</span>
            <span class="font-medium text-blue-600">${verifiedServices}</span>
          </div>
          <div class="flex justify-between">
            <span>Remaining:</span>
            <span class="font-medium text-red-600">${remainingServices}</span>
          </div>
          <div class="pt-3 border-t mt-3">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${Math.round(((completedServices + verifiedServices) / totalServices) * 100)}%"></div>
            </div>
          </div>
        </div>
      `;
      
      modal.classList.add('active');
      const closeButton = document.getElementById('modalCloseButton') as HTMLElement;
      if (closeButton) {
        closeButton.onclick = function() {
          modal.classList.remove('active');
        };
      }
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      };
    }

    // Generate reference code
    function generateReferenceCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return `${result.substring(0, 4)}-${result.substring(4)}`;
    }

    // Setup reference code generation
    function setupReferenceCodeGenerationreg() {
      const regstudentNumberInput = document.querySelector('input[name="regstudids"]') as HTMLInputElement;
      const regcourseInput = document.querySelector('input[name="regcourses"]') as HTMLInputElement;
      const regyearLevelInputs = document.querySelectorAll('input[name="regyearlevels"]') as NodeListOf<HTMLInputElement>;
      const regreferenceCodeInput = document.getElementById('regreferenceCodeInputs') as HTMLInputElement;
      const regcopyBtn = document.getElementById('regcopyReferenceCodeBtns') as HTMLElement;
      
      function regupdateReferenceCode() {
        const regstudentNumber = regstudentNumberInput?.value.trim();
        const regcourse = regcourseInput?.value.trim();
        let regyearLevel = '';
        
        // Find the checked year level radio button
        regyearLevelInputs.forEach(input => {
          if (input.checked) {
            regyearLevel = input.value;
          }
        });
        
        if (regstudentNumber && regcourse && regyearLevel) {
          const code = generateReferenceCode();
          regreferenceCodeInput.value = code;
          regreferenceCodeInput.classList.remove('bg-gray-100');
          regreferenceCodeInput.classList.add('bg-yellow-100', 'border-yellow-300');
        } else {
          regreferenceCodeInput.value = '';
          regreferenceCodeInput.classList.add('bg-gray-100');
          regreferenceCodeInput.classList.remove('bg-yellow-100', 'border-yellow-300');
        }
      }
      
      if (regstudentNumberInput) regstudentNumberInput.addEventListener('input', regupdateReferenceCode);
      if (regcourseInput) regcourseInput.addEventListener('input', regupdateReferenceCode);
      if (regyearLevelInputs) {
        regyearLevelInputs.forEach(input => {
          input.addEventListener('change', regupdateReferenceCode);
        });
      }
      
      if (regcopyBtn) {
        regcopyBtn.addEventListener('click', () => {
          if (regreferenceCodeInput.value) {
            regreferenceCodeInput.select();
            document.execCommand('copy');
            
            const originalHtml = regcopyBtn.innerHTML;
            regcopyBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            `;
            
            setTimeout(() => {
              regcopyBtn.innerHTML = originalHtml;
            }, 2000);
          }
        });
      }
      
      // Initial update
      regupdateReferenceCode();
    }

    // Form submission handler
    const surveyForm = document.getElementById('studentSurveyForm') as HTMLFormElement;
    if (surveyForm) {
      let isSubmitting = false;
      
      surveyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (isSubmitting) return;
        isSubmitting = true;
        
        // Create and show loader
        const loader = document.createElement('div');
        loader.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loader.innerHTML = `
          <div class="loader-container bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-msu-main-color mb-4"></div>
            <p class="text-gray-700 font-medium">Submitting your survey...</p>
          </div>
        `;
        document.body.appendChild(loader);
        
        // Disable submit button
        const submitButton = surveyForm.querySelector('button[type="submit"]') as HTMLButtonElement;
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = 'Submitting...';
        }
        
        // Check internet connection
        if (!checkInternetConnectionreg()) {
          loader.remove();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
          showModal('error', 'No internet connection detected. Please connect to the internet to submit your survey.');
          return;
        }
        
        // Validate student info
        const regyearLevel = document.querySelector('input[name="regyearlevels"]:checked') as HTMLInputElement;
        const regcourse = document.querySelector('input[name="regcourses"]') as HTMLInputElement;
        const regstudentNumber = document.querySelector('input[name="regstudids"]') as HTMLInputElement;
        
        if (!regyearLevel) {
          loader.remove();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
          showModal('error', 'Please select your year level');
          return;
        }
        
        if (!regcourse || !regcourse.value.trim()) {
          regcourse.classList.add('border-red-500');
          loader.remove();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
          showModal('error', 'Please enter your course');
          return;
        }
        
        if (!regstudentNumber || !regstudentNumber.value.trim()) {
          regstudentNumber.classList.add('border-red-500');
          loader.remove();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
          showModal('error', 'Please enter your student number');
          return;
        }
        
        // Validate selected services
        const selectedServices = document.querySelectorAll('.service-card.selected');
        let allServicesValid = true;
        let invalidServices: string[] = [];
        
        selectedServices.forEach(card => {
          const cardElement = card as HTMLElement;
          const titleElement = cardElement.querySelector('.service-card-title');
          if (!titleElement) return;
          
          const title = titleElement.textContent?.trim();
          if (!title) return;
          
          const isValid = validateServiceQuestions(cardElement);
          
          if (!isValid) {
            allServicesValid = false;
            invalidServices.push(title);
            cardElement.classList.add('border-red-500');
          }
        });
        
        if (!allServicesValid) {
          loader.remove();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
          showModal('error', `Please complete all questions in these services:<br><br>${invalidServices.join('<br>')}`);
          return;
        }
        
        // Prepare form data
        const formData = new FormData(surveyForm);
        
        // Create hidden iframe for form submission
        const hiddenIframe = document.createElement('iframe');
        hiddenIframe.name = 'hidden_iframe';
        hiddenIframe.style.display = 'none';
        document.body.appendChild(hiddenIframe);
        
        // Create hidden form for submission
        const hiddenForm = document.createElement('form');
        hiddenForm.style.display = 'none';
        hiddenForm.method = 'POST';
        hiddenForm.action = 'https://docs.google.com/forms/u/1/d/e/1FAIpQLSdLYEEuopI3SKfJZ8bsklxYmHUPZoLtPK2QRtv81_YBFBrHFw/formResponse';
        hiddenForm.target = 'hidden_iframe';
        
        formData.forEach((value, key) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value.toString();
          hiddenForm.appendChild(input);
        });
        
        document.body.appendChild(hiddenForm);
        
        // Mark all services as verified
        Object.keys(services).forEach(service => {
          services[service].verified = true;
          services[service].completed = true;
        });
        
        updateRegProgressTracker();
        
        // Show success message with details
        const studentData = {
          regreferenceCode: (document.getElementById('regreferenceCodeInputs') as HTMLInputElement).value,
          regstudentId: regstudentNumber?.value || '',
          regcourse: regcourse?.value || '',
          regyearLevel: regyearLevel?.value || ''
        };
        
        // Remove loader before showing success message
        loader.remove();
        showSubmissionSuccess(studentData);
        
        // Submit the form
        hiddenForm.submit();
        
        // Remove the hidden form after submission
        setTimeout(() => {
          hiddenForm.remove();
          hiddenIframe.remove();
        }, 1000);
        
        // Reset form after successful submission
        setTimeout(() => {
          surveyForm.reset();
          initializeVerificationStatusreg();
          updateRegProgressTracker();
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Survey';
          }
        }, 3000);
      });
    }

    // Show submission success with details
    function showSubmissionSuccess(data: { regreferenceCode: string; regstudentId: string; regcourse: string; regyearLevel: string }) {
      const modal = document.getElementById('feedbackModal') as HTMLElement;
      const modalMessage = document.getElementById('modalMessage') as HTMLElement;
      const modalIcon = modal.querySelector('.modal-icon') as HTMLElement;
      const modalTitle = modal.querySelector('.modal-title') as HTMLElement;
      
      modalTitle.textContent = 'Submission Successful';
      modalIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
      
      modalMessage.innerHTML = `
        <div class="space-y-4">
          <div id="receiptContent" class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-msu-main-color">Survey Submission Receipt</h3>
              <div class="flex items-center space-x-2">
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Verified</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">${new Date().toLocaleDateString()}</span>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-3">
              <div>
                <p class="text-sm text-gray-500">Reference Code</p>
                <p class="font-mono font-bold text-lg">${data.regreferenceCode}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Student ID</p>
                <p class="font-medium">${data.regstudentId}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Course</p>
                <p class="font-medium">${data.regcourse}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Year Level</p>
                <p class="font-medium">${data.regyearLevel}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Submission Date</p>
                <p class="font-medium">${new Date().toLocaleString()}</p>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-msu-main-color" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span class="text-sm text-gray-600">Thank you for your feedback submission</span>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
            <p class="text-sm text-blue-700 mb-3">Please note your reference code for future inquiries.</p>
            <button id="downloadReceiptBtn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gradient-to-r from-msu-main-color to-msu-maroon hover:from-msu-main-color-dark hover:to-msu-maroon-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-msu-main-color">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Download Receipt as Image
            </button>
          </div>
        </div>
      `;
      
      modal.classList.add('active');
      
      const closeButton = document.getElementById('modalCloseButton') as HTMLElement;
      if (closeButton) {
        closeButton.onclick = function() {
          modal.classList.remove('active');
        };
      }
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      };

      // Add event listener for download button
      const downloadBtn = document.getElementById('downloadReceiptBtn') as HTMLButtonElement;
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          downloadReceiptAsImage();
        });
      }

      // Function to download the receipt as image
      async function downloadReceiptAsImage() {
        const downloadBtn = document.getElementById('downloadReceiptBtn') as HTMLButtonElement;
        if (!downloadBtn) return;
        
        const originalBtnContent = downloadBtn.innerHTML;
        
        // Show loading state on button
        downloadBtn.innerHTML = `
          <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Generating Image...
        `;
        downloadBtn.disabled = true;

        try {
          // Use html2canvas library to convert the div to an image
          const html2canvas = await loadHtml2Canvas();
          const receiptElement = document.getElementById('receiptContent') as HTMLElement;
          if (!receiptElement) throw new Error('Receipt element not found');
          
          // Add some temporary styles for better screenshot
          receiptElement.style.boxShadow = 'none';
          receiptElement.style.border = '1px solid #e5e7eb';
          receiptElement.style.borderRadius = '0.5rem';
          receiptElement.style.padding = '1.5rem';
          
          const canvas = await (html2canvas as any)(receiptElement, {
            scale: 2, // Higher quality
            logging: false,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          });
          
          // Create download link
          const link = document.createElement('a');
          link.download = `MSU-Survey-Receipt-${data.regreferenceCode}.jpg`;
          link.href = canvas.toDataURL('image/jpeg', 0.9);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Show success feedback
          const modalIcon = document.querySelector('#feedbackModal .modal-icon') as HTMLElement;
          if (modalIcon) {
            modalIcon.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            `;
          }
        } catch (error) {
          console.error('Error generating image:', error);
          // Show error feedback
          const modalIcon = document.querySelector('#feedbackModal .modal-icon') as HTMLElement;
          if (modalIcon) {
            modalIcon.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            `;
          }
        } finally {
          // Restore button state
          downloadBtn.innerHTML = originalBtnContent;
          downloadBtn.disabled = false;
        }
      }

      // Function to dynamically load html2canvas
      function loadHtml2Canvas() {
        return new Promise((resolve, reject) => {
          if ((window as any).html2canvas) {
            resolve((window as any).html2canvas);
            return;
          }
          
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
          script.onload = () => resolve((window as any).html2canvas);
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
    }

    // Modal control
    function showModal(type: 'success' | 'error', message: string) {
      const modal = document.getElementById('feedbackModal') as HTMLElement;
      const modalMessage = document.getElementById('modalMessage') as HTMLElement;
      const modalIcon = modal.querySelector('.modal-icon') as HTMLElement;
      const modalTitle = modal.querySelector('.modal-title') as HTMLElement;
      
      modalMessage.innerHTML = message;
      
      if (type === 'success') {
        modal.classList.remove('modal-error');
        modal.classList.add('modal-success');
        modalTitle.textContent = 'Success!';
        modalIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        `;
      } else {
        modal.classList.remove('modal-success');
        modal.classList.add('modal-error');
        modalTitle.textContent = 'Attention Required';
        modalIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        `;
      }
      
      modal.classList.add('active');
      
      const closeButton = document.getElementById('modalCloseButton') as HTMLElement;
      if (closeButton) {
        closeButton.onclick = function() {
          modal.classList.remove('active');
        };
      }
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      };
    }

    // Initialize the student survey
    initializeVerificationStatusreg();
    createRegProgressTracker();
    setupReferenceCodeGenerationreg();
    updateRegProgressTracker();
    
    // Verify services count matches survey
    const expectedServices = ['Library Services', 'Guidance Services'];
    const actualServices = Object.keys(services);
    console.log('Expected services:', expectedServices);
    console.log('Actual services found:', actualServices);
    console.log('Services count match:', expectedServices.length === actualServices.length);
  }

  // Add connectivity status monitoring
  window.addEventListener('online', () => {
    console.log('Internet connection restored');
  });

  window.addEventListener('offline', () => {
    // Define showModal function in global scope for offline event
    function showModal(type: 'success' | 'error', message: string) {
      const modal = document.getElementById('feedbackModal') as HTMLElement;
      const modalMessage = document.getElementById('modalMessage') as HTMLElement;
      const modalIcon = modal.querySelector('.modal-icon') as HTMLElement;
      const modalTitle = modal.querySelector('.modal-title') as HTMLElement;
      
      modalMessage.innerHTML = message;
      
      if (type === 'success') {
        modal.classList.remove('modal-error');
        modal.classList.add('modal-success');
        modalTitle.textContent = 'Success!';
        modalIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        `;
      } else {
        modal.classList.remove('modal-success');
        modal.classList.add('modal-error');
        modalTitle.textContent = 'Attention Required';
        modalIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        `;
      }
      
      modal.classList.add('active');
      
      const closeButton = document.getElementById('modalCloseButton') as HTMLElement;
      if (closeButton) {
        closeButton.onclick = function() {
          modal.classList.remove('active');
        };
      }
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      };
    }
    
    showModal('error', 'Internet connection lost. Please reconnect to submit your survey.');
  });

  // Add styles
  const style = document.createElement('style');
  style.textContent = `
    .service-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
    }
    .service-card.selected {
      border-color: #1a4b8c;
      box-shadow: 0 0 0 3px rgba(26, 75, 140, 0.1);
    }
    .service-card-header {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    .service-card-icon {
      margin-right: 1rem;
      color: #1a4b8c;
    }
    .service-card-title {
      font-weight: 600;
      font-size: 1.125rem;
      color: #111827;
    }
    .service-card-checkbox {
      margin-right: 0.75rem;
    }
    .verification-status {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      font-weight: bold;
      font-size: 0.875rem;
    }
    .verification-status.verified {
      background-color: #10B981;
      color: white;
    }
    .verification-status.completed {
      background-color: #3B82F6;
      color: white;
    }
    .verification-status.not-completed {
      background-color: #EF4444;
      color: white;
    }
    .verification-legend {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .verification-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4B5563;
    }
    .verification-legend-badge {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    .verification-legend-badge.verified {
      background-color: #10B981;
      color: white;
    }
    .verification-legend-badge.completed {
      background-color: #3B82F6;
      color: white;
    }
    .verification-legend-badge.not-completed {
      background-color: #EF4444;
      color: white;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 1.5rem;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .modal-icon {
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
    }
    .modal-close {
      color: #9ca3af;
      font-size: 1.5rem;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
    }
    .modal-close:hover {
      color: #6b7280;
    }
    .modal-body {
      color: #4b5563;
      line-height: 1.5;
    }
    .modal-success {
      border-left: 4px solid #10B981;
    }
    .modal-error {
      border-left: 4px solid #EF4444;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    .loader {
      border-top-color: #1a4b8c;
      border-right-color: #1a4b8c;
      border-bottom-color: #8b1a1a;
      border-left-color: #d4af37;
      animation-timing-function: cubic-bezier(0.53, 0.21, 0.29, 0.67);
    }
    .reg-progress-tracker {
      position: fixed;
      bottom: 2rem;
      left: 2rem;
      width: 4rem;
      height: 4rem;
      cursor: pointer;
      z-index: 9999;
      background: white;
      border-radius: 50%;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      /* Ensure it shows in front */
      pointer-events: auto;
      /* Create new stacking context */
      isolation: isolate;
      /* Add glow effect to make it more visible */
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
    }
    .reg-progress-circle {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .reg-progress-bg, .reg-progress-fill {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .reg-progress-bg path {
      stroke: #e5e7eb;
      stroke-width: 3;
    }
    .reg-progress-fill path {
      stroke: #1a4b8c;
      stroke-width: 3;
      stroke-linecap: round;
      transition: stroke-dasharray 0.6s ease;
    }
    .reg-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.875rem;
      font-weight: bold;
      color: #1a4b8c;
    }
    .missing-question {
      animation: pulse 1.5s ease-in-out infinite;
      background-color: rgba(239, 68, 68, 0.1);
      border-radius: 0.5rem;
      padding: 0.5rem;
    }
    @keyframes pulse {
      0% { background-color: rgba(239, 68, 68, 0.1); }
      50% { background-color: rgba(239, 68, 68, 0.3); }
      100% { background-color: rgba(239, 68, 68, 0.1); }
    }
    .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    @keyframes highlight-pulse {
      0% { background-color: rgba(234, 179, 8, 0.2); }
      50% { background-color: rgba(234, 179, 8, 0.4); }
      100% { background-color: rgba(234, 179, 8, 0.2); }
    }
    .bg-yellow-100 {
      background-color: rgba(254, 243, 199, 1);
      animation: highlight-pulse 2s ease-in-out infinite;
    }
    iframe[name="hidden_iframe"] {
      display: none;
    }
    /* Loader Styles */
    .loader {
      border-top-color: #1a4b8c;
      border-right-color: #1a4b8c;
      border-bottom-color: #8b1a1a;
      border-left-color: #d4af37;
      animation-timing-function: cubic-bezier(0.53, 0.21, 0.29, 0.67);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1.2s linear infinite;
    }
    .loader-container {
      min-width: 320px;
      max-width: 90%;
      transition: all 0.3s ease;
    }
    .progress-bar {
      transition: width 0.6s ease;
    }
    .loader-logo {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }
    button[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }
  `;
  document.head.appendChild(style);
});
</script>